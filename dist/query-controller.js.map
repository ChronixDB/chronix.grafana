{"version":3,"sources":["../src/query-controller.js"],"names":["isInt","n","parseInt","QueryCtrl","_","ChronixDbQueryController","$scope","$injector","panel","stack","downsampling","target","sampling","suggestAttributes","query","callback","datasource","then","getTextValues","bind","suggestTagValues","suggestAttributesValues","name","currentTagKey","suggestTagAttributes","suggestMetrics","findTimeSeriesByNames","validateTarget","errs","convertToChronixInterval","err","message","errors","isEqual","oldTarget","isEmpty","angular","copy","panelCtrl","refresh","metricFindResult","map","value","text","console","info","attributes","currentAttributeKey","attribute","index","indexOf","splice","size","targetBlur","addJoinAttributeMode","validateJoinAttributes","push","addFilterTagMode","validateFilterTag","tags","has","currentTagValue","key","addGroupByMode","currentGroupByType","isTagGroupBy","validateGroupBy","groupBy","groupByTags","contains","tagKey","nonTagGroupBys","isValueGroupBy","range_size","valueRange","isTimeGroupBy","timeInterval","group_count","groupCount","values","isGroupByValid","addHorizontalAggregatorMode","currentHorizontalAggregatorName","hasSamplingRate","validateHorizontalAggregator","horAggregator","horizontalAggregators","aggregator","sampling_rate","samplingRate","hasUnit","unit","hasFactor","factor","hasPercentile","percentile","isAggregatorValid","alert","templateUrl"],"mappings":"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","file":"query-controller.js","sourcesContent":["import { QueryCtrl } from 'app/plugins/sdk';\nimport _ from 'lodash';\n\nfunction isInt (n) {\n    return parseInt(n) % 1 === 0;\n}\n\nexport class ChronixDbQueryController extends QueryCtrl {\n\n    constructor ($scope, $injector) {\n        super($scope, $injector);\n\n        this.panel.stack = false;\n\n        if (!this.panel.downsampling) {\n            this.panel.downsampling = 'avg';\n        }\n\n        if (!this.target.downsampling) {\n            this.target.downsampling = this.panel.downsampling;\n            this.target.sampling = this.panel.sampling;\n        }\n\n        /**\n         * Is called if someone types something into a key field of an attribute.\n         */\n        this.suggestAttributes = (query, callback) => {\n            this.datasource.suggestAttributes()\n                .then(this.getTextValues.bind(this))\n                .then(callback);\n        };\n\n        /**\n         * Is called if someone types something into a value field of an attribute.\n         */\n        this.suggestTagValues = (query, callback) => {\n            this.datasource.suggestAttributesValues(this.target.name, this.target.currentTagKey)\n                .then(this.getTextValues.bind(this))\n                .then(callback);\n        };\n\n        /**\n         * Is called if someone types something into a key field of an attribute.\n         */\n        this.suggestTagAttributes = (query, callback) => {\n            this.datasource.suggestAttributes(query)\n                .then(this.getTextValues.bind(this))\n                .then(callback);\n        };\n\n        this.suggestMetrics = (query, callback) => {\n            this.datasource.findTimeSeriesByNames(query)\n                .then(this.getTextValues.bind(this))\n                .then(callback);\n        };\n\n        this.validateTarget();\n    }\n\n    validateTarget () {\n        var errs = {};\n\n        if (!this.target.name) {\n            errs.name = \"You must supply a time series name.\";\n        }\n\n        try {\n            if (this.target.sampling) {\n                this.datasource.convertToChronixInterval(this.target.sampling);\n            }\n        } catch (err) {\n            errs.sampling = err.message;\n        }\n\n        this.target.errors = errs;\n    }\n\n    targetBlur () {\n        this.validateTarget();\n\n        if (!_.isEqual(this.oldTarget, this.target) && _.isEmpty(this.target.errors)) {\n            this.oldTarget = angular.copy(this.target);\n            this.panelCtrl.refresh();\n        }\n    };\n\n    getTextValues (metricFindResult) {\n        return _.map(metricFindResult, function (value) {\n            return value.text;\n        });\n    };\n\n    /**\n     * =========================================================================\n     *\n     *  Join section\n     *\n     * =========================================================================\n     */\n\n    /**\n     * Is called if someone types something into the join by box\n     * @param query\n     * @param callback\n     */\n    addJoinByAttribute (query, callback) {\n        console.info(\"add join by attribute is called for \" + query);\n\n        this.datasource.suggestAttributes(query)\n            .then(this.getTextValues.bind(this))\n            .then(callback);\n    };\n\n    validateJoinAttributes () {\n        console.info(\"validateJoinAttributes is called\");\n        this.target.errors.attributes = null;\n        if (!this.target.currentAttributeKey) {\n            this.target.errors.attributes = \"You must specify a tag name and value.\";\n        }\n    };\n\n    /**\n     * Is calls if someone removes a group by tag\n     * @param attribute\n     */\n    removeJoinByAttribute (attribute) {\n        console.info(\"removeJoinByAttribute is called for \" + attribute);\n\n        var index = this.target.attributes.indexOf(attribute);\n\n        this.target.attributes.splice(index, 1);\n\n        if (_.size(this.target.attributes) === 0) {\n            this.target.attributes = null;\n        }\n        this.targetBlur();\n    };\n\n    /**\n     * Add join by attribute\n     */\n    addJoinByAttribute () {\n        console.info(\"addJoinByAttribute is called\");\n        if (!this.panel.addJoinAttributeMode) {\n            this.panel.addJoinAttributeMode = true;\n            this.validateJoinAttributes();\n            return;\n        }\n\n        if (!this.target.attributes) {\n            this.target.attributes = [];\n        }\n\n        this.validateJoinAttributes();\n        if (!this.target.errors.attributes) {\n            this.target.attributes.push(this.target.currentAttributeKey);\n            this.target.currentAttributeKey = '';\n\n            this.targetBlur();\n        }\n\n        this.panel.addJoinAttributeMode = false;\n    };\n\n    // Filter metric by tag\n    addFilterTag () {\n        if (!this.panel.addFilterTagMode) {\n            this.panel.addFilterTagMode = true;\n            this.validateFilterTag();\n            return;\n        }\n\n        if (!this.target.tags) {\n            this.target.tags = {};\n        }\n\n        this.validateFilterTag();\n        if (!this.target.errors.tags) {\n            if (!_.has(this.target.tags, this.target.currentTagKey)) {\n                this.target.tags[this.target.currentTagKey] = [];\n            }\n            this.target.tags[this.target.currentTagKey].push(this.target.currentTagValue);\n            this.target.currentTagKey = '';\n            this.target.currentTagValue = '';\n            this.targetBlur();\n        }\n\n        this.panel.addFilterTagMode = false;\n    };\n\n    removeFilterTag (key) {\n        delete this.target.tags[key];\n        if (_.size(this.target.tags) === 0) {\n            this.target.tags = null;\n        }\n        this.targetBlur();\n    };\n\n    validateFilterTag () {\n        this.target.errors.tags = null;\n        if (!this.target.currentTagKey || !this.target.currentTagValue) {\n            this.target.errors.tags = \"You must specify a tag name and value.\";\n        }\n    };\n\n    //////////////////////////////\n    // GROUP BY\n    //////////////////////////////\n    addGroupBy () {\n        if (!this.panel.addGroupByMode) {\n            this.target.currentGroupByType = 'tag';\n            this.panel.addGroupByMode = true;\n            this.panel.isTagGroupBy = true;\n            this.validateGroupBy();\n            return;\n        }\n        this.validateGroupBy();\n        // nb: if error is found, means that user clicked on cross : cancels input\n\n        if (_.isEmpty(this.target.errors.groupBy)) {\n            if (this.panel.isTagGroupBy) {\n                if (!this.target.groupByTags) {\n                    this.target.groupByTags = [];\n                }\n                if (!_.contains(this.target.groupByTags, this.target.groupBy.tagKey)) {\n                    this.target.groupByTags.push(this.target.groupBy.tagKey);\n                    this.targetBlur();\n                }\n                this.target.groupBy.tagKey = '';\n            }\n            else {\n                if (!this.target.nonTagGroupBys) {\n                    this.target.nonTagGroupBys = [];\n                }\n                var groupBy = {\n                    name: this.target.currentGroupByType\n                };\n                if (this.panel.isValueGroupBy) {\n                    groupBy.range_size = this.target.groupBy.valueRange;\n                } else if (this.panel.isTimeGroupBy) {\n                    groupBy.range_size = this.target.groupBy.timeInterval;\n                    groupBy.group_count = this.target.groupBy.groupCount;\n                }\n                this.target.nonTagGroupBys.push(groupBy);\n            }\n            this.targetBlur();\n        }\n\n        this.panel.isTagGroupBy = false;\n        this.panel.isValueGroupBy = false;\n        this.panel.isTimeGroupBy = false;\n        this.panel.addGroupByMode = false;\n    };\n\n    removeGroupByTag (index) {\n        this.target.groupByTags.splice(index, 1);\n        if (_.size(this.target.groupByTags) === 0) {\n            this.target.groupByTags = null;\n        }\n        this.targetBlur();\n    };\n\n    removeNonTagGroupBy (index) {\n        this.target.nonTagGroupBys.splice(index, 1);\n        if (_.size(this.target.nonTagGroupBys) === 0) {\n            this.target.nonTagGroupBys = null;\n        }\n        this.targetBlur();\n    };\n\n    changeGroupByInput () {\n        this.panel.isTagGroupBy = this.target.currentGroupByType === 'tag';\n        this.panel.isValueGroupBy = this.target.currentGroupByType === 'value';\n        this.panel.isTimeGroupBy = this.target.currentGroupByType === 'time';\n        this.validateGroupBy();\n    };\n\n    getValuesOfGroupBy (groupBy) {\n        return _.values(groupBy);\n    };\n\n    validateGroupBy () {\n        delete this.target.errors.groupBy;\n        var errors = {};\n        this.panel.isGroupByValid = true;\n        if (this.panel.isTagGroupBy) {\n            if (!this.target.groupBy.tagKey) {\n                this.panel.isGroupByValid = false;\n                errors.tagKey = 'You must supply a tag name';\n            }\n        }\n\n        if (this.panel.isValueGroupBy) {\n            if (!this.target.groupBy.valueRange || !isInt(this.target.groupBy.valueRange)) {\n                errors.valueRange = \"Range must be an integer\";\n                this.isGroupByValid = false;\n            }\n        }\n\n        if (this.panel.isTimeGroupBy) {\n            try {\n                this.datasource.convertToChronixInterval(this.target.groupBy.timeInterval);\n            } catch (err) {\n                errors.timeInterval = err.message;\n                this.isGroupByValid = false;\n            }\n            if (!this.target.groupBy.groupCount || !isInt(this.target.groupBy.groupCount)) {\n                errors.groupCount = \"Group count must be an integer\";\n                this.isGroupByValid = false;\n            }\n        }\n\n        if (!_.isEmpty(errors)) {\n            this.target.errors.groupBy = errors;\n        }\n    };\n\n    //////////////////////////////\n    // HORIZONTAL AGGREGATION\n    //////////////////////////////\n\n    addHorizontalAggregator () {\n        if (!this.panel.addHorizontalAggregatorMode) {\n            this.panel.addHorizontalAggregatorMode = true;\n            this.target.currentHorizontalAggregatorName = 'avg';\n            this.panel.hasSamplingRate = true;\n            this.validateHorizontalAggregator();\n            return;\n        }\n\n        this.validateHorizontalAggregator();\n        // nb: if error is found, means that user clicked on cross : cancels input\n        if (_.isEmpty(this.target.errors.horAggregator)) {\n            if (!this.target.horizontalAggregators) {\n                this.target.horizontalAggregators = [];\n            }\n            var aggregator = {\n                name: this.target.currentHorizontalAggregatorName\n            };\n            if (this.panel.hasSamplingRate) {\n                aggregator.sampling_rate = this.target.horAggregator.samplingRate;\n            }\n            if (this.panel.hasUnit) {\n                aggregator.unit = this.target.horAggregator.unit;\n            }\n            if (this.panel.hasFactor) {\n                aggregator.factor = this.target.horAggregator.factor;\n            }\n            if (this.panel.hasPercentile) {\n                aggregator.percentile = this.target.horAggregator.percentile;\n            }\n            this.target.horizontalAggregators.push(aggregator);\n            this.targetBlur();\n        }\n\n        this.panel.addHorizontalAggregatorMode = false;\n        this.panel.hasSamplingRate = false;\n        this.panel.hasUnit = false;\n        this.panel.hasFactor = false;\n        this.panel.hasPercentile = false;\n    };\n\n    removeHorizontalAggregator (index) {\n        this.target.horizontalAggregators.splice(index, 1);\n        if (_.size(this.target.horizontalAggregators) === 0) {\n            this.target.horizontalAggregators = null;\n        }\n\n        this.targetBlur();\n    };\n\n    changeHorAggregationInput () {\n        this.panel.hasSamplingRate = _.contains(['avg', 'dev', 'max', 'min', 'sum', 'least_squares', 'count', 'percentile'],\n            this.target.currentHorizontalAggregatorName);\n        this.panel.hasUnit = _.contains(['sampler', 'rate'], this.target.currentHorizontalAggregatorName);\n        this.panel.hasFactor = _.contains(['div', 'scale'], this.target.currentHorizontalAggregatorName);\n        this.panel.hasPercentile = 'percentile' === this.target.currentHorizontalAggregatorName;\n        this.validateHorizontalAggregator();\n    };\n\n    validateHorizontalAggregator () {\n        delete this.target.errors.horAggregator;\n        var errors = {};\n        this.panel.isAggregatorValid = true;\n\n        if (this.panel.hasSamplingRate) {\n            try {\n                this.datasource.convertToChronixInterval(this.target.horAggregator.samplingRate);\n            } catch (err) {\n                errors.samplingRate = err.message;\n                this.panel.isAggregatorValid = false;\n            }\n        }\n\n        if (this.hasFactor) {\n            if (!this.target.horAggregator.factor) {\n                errors.factor = 'You must supply a numeric value for this aggregator';\n                this.panel.isAggregatorValid = false;\n            }\n            else if (parseInt(this.target.horAggregator.factor) === 0 && this.target.currentHorizontalAggregatorName === 'div') {\n                errors.factor = 'Cannot divide by 0';\n                this.panel.isAggregatorValid = false;\n            }\n        }\n\n        if (this.panel.hasPercentile) {\n            if (!this.target.horAggregator.percentile ||\n                this.target.horAggregator.percentile <= 0 ||\n                this.target.horAggregator.percentile > 1) {\n                errors.percentile = 'Percentile must be between 0 and 1';\n                this.panel.isAggregatorValid = false;\n            }\n        }\n\n        if (!_.isEmpty(errors)) {\n            this.target.errors.horAggregator = errors;\n        }\n    };\n\n    alert (message) {\n        alert(message);\n    };\n\n}\n\nChronixDbQueryController.templateUrl = 'partials/query.editor.html';\n"]}