{"version":3,"sources":["../src/query-controller.js"],"names":["isInt","n","parseInt","QueryCtrl","_","ChronixDbQueryController","$scope","$injector","panel","stack","downsampling","target","sampling","validateTarget","errs","metric","datasource","convertToChronixInterval","err","message","errors","isEqual","oldTarget","isEmpty","angular","copy","panelCtrl","refresh","metricFindResult","map","value","text","query","callback","metricFindQuery","then","getTextValues","bind","console","info","suggestAttributes","log","attributes","currentAttributeKey","attribute","index","indexOf","splice","size","targetBlur","addJoinAttributeMode","validateJoinAttributes","push","suggestAttributesValues","currentTagKey","addFilterTagMode","validateFilterTag","tags","has","currentTagValue","key","addGroupByMode","currentGroupByType","isTagGroupBy","validateGroupBy","groupBy","groupByTags","contains","tagKey","nonTagGroupBys","name","isValueGroupBy","range_size","valueRange","isTimeGroupBy","timeInterval","group_count","groupCount","values","isGroupByValid","addHorizontalAggregatorMode","currentHorizontalAggregatorName","hasSamplingRate","validateHorizontalAggregator","horAggregator","horizontalAggregators","aggregator","sampling_rate","samplingRate","hasUnit","unit","hasFactor","factor","hasPercentile","percentile","isAggregatorValid","alert","templateUrl"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGA,aAASA,KAAT,CAAgBC,CAAhB,EAAmB;AACf,eAAOC,SAASD,CAAT,IAAc,CAAd,KAAoB,CAA3B;AACH;;;;AALOE,qB,kBAAAA,S;;AACDC,a;;;;;;;;;;;;;;;;;;;;;gDAMMC,wB;;;AAET,kDAAaC,MAAb,EAAqBC,SAArB,EAAgC;AAAA;;AAAA,oKACtBD,MADsB,EACdC,SADc;;AAG5B,0BAAKC,KAAL,CAAWC,KAAX,GAAmB,KAAnB;;AAEA,wBAAI,CAAC,MAAKD,KAAL,CAAWE,YAAhB,EAA8B;AAC1B,8BAAKF,KAAL,CAAWE,YAAX,GAA0B,KAA1B;AACH;;AAED,wBAAI,CAAC,MAAKC,MAAL,CAAYD,YAAjB,EAA+B;AAC3B,8BAAKC,MAAL,CAAYD,YAAZ,GAA2B,MAAKF,KAAL,CAAWE,YAAtC;AACA,8BAAKC,MAAL,CAAYC,QAAZ,GAAuB,MAAKJ,KAAL,CAAWI,QAAlC;AACH;;AAED,0BAAKC,cAAL;AAd4B;AAe/B;;;;qDAEiB;AACd,4BAAIC,OAAO,EAAX;;AAEA,4BAAI,CAACH,OAAOI,MAAZ,EAAoB;AAChBD,iCAAKC,MAAL,GAAc,gCAAd;AACH;;AAED,4BAAI;AACA,gCAAIJ,OAAOC,QAAX,EAAqB;AACjB,qCAAKI,UAAL,CAAgBC,wBAAhB,CAAyCN,OAAOC,QAAhD;AACH;AACJ,yBAJD,CAIE,OAAOM,GAAP,EAAY;AACVJ,iCAAKF,QAAL,GAAgBM,IAAIC,OAApB;AACH;;AAED,6BAAKR,MAAL,CAAYS,MAAZ,GAAqBN,IAArB;AACH;;;iDAEa;AACV,6BAAKD,cAAL;;AAEA,4BAAI,CAACT,EAAEiB,OAAF,CAAU,KAAKC,SAAf,EAA0B,KAAKX,MAA/B,CAAD,IAA2CP,EAAEmB,OAAF,CAAU,KAAKZ,MAAL,CAAYS,MAAtB,CAA/C,EAA8E;AAC1E,iCAAKE,SAAL,GAAiBE,QAAQC,IAAR,CAAa,KAAKd,MAAlB,CAAjB;AACA,iCAAKe,SAAL,CAAeC,OAAf;AACH;AACJ;;;kDAEcC,gB,EAAkB;AAC7B,+BAAOxB,EAAEyB,GAAF,CAAMD,gBAAN,EAAwB,UAAUE,KAAV,EAAiB;AAC5C,mCAAOA,MAAMC,IAAb;AACH,yBAFM,CAAP;AAGH;;;mDAEeC,K,EAAOC,Q,EAAU;AAC7B,6BAAKjB,UAAL,CAAgBkB,eAAhB,CAAgC,aAAaF,KAAb,GAAqB,GAArD,EACKG,IADL,CACU,KAAKC,aAAL,CAAmBC,IAAnB,CAAwB,IAAxB,CADV,EAEKF,IAFL,CAEUF,QAFV;AAGH;;;uDAemBD,K,EAAOC,Q,EAAU;AACjCK,gCAAQC,IAAR,CAAa,yCAAyCP,KAAtD;;AAEA,6BAAKhB,UAAL,CAAgBwB,iBAAhB,CAAkCR,KAAlC,EACKG,IADL,CACU,KAAKC,aAAL,CAAmBC,IAAnB,CAAwB,IAAxB,CADV,EAEKF,IAFL,CAEUF,QAFV;AAGH;;;yDAOqBD,K,EAAOC,Q,EAAU;AACnCK,gCAAQG,GAAR,CAAY,wCAAwCT,KAApD;;AAEA,6BAAKhB,UAAL,CAAgBwB,iBAAhB,CAAkCR,KAAlC,EACKG,IADL,CACU,KAAKC,aAAL,CAAmBC,IAAnB,CAAwB,IAAxB,CADV,EAEKF,IAFL,CAEUF,QAFV;AAGH;;;6DAEyB;AACtBK,gCAAQC,IAAR,CAAa,kCAAb;AACA,6BAAK5B,MAAL,CAAYS,MAAZ,CAAmBsB,UAAnB,GAAgC,IAAhC;AACA,4BAAI,CAAC,KAAK/B,MAAL,CAAYgC,mBAAjB,EAAsC;AAClC,iCAAKhC,MAAL,CAAYS,MAAZ,CAAmBsB,UAAnB,GAAgC,wCAAhC;AACH;AACJ;;;0DAMsBE,S,EAAW;AAC9BN,gCAAQC,IAAR,CAAa,yCAAyCK,SAAtD;;AAEA,4BAAIC,QAAQ,KAAKlC,MAAL,CAAY+B,UAAZ,CAAuBI,OAAvB,CAA+BF,SAA/B,CAAZ;;AAEA,6BAAKjC,MAAL,CAAY+B,UAAZ,CAAuBK,MAAvB,CAA8BF,KAA9B,EAAqC,CAArC;;AAEA,4BAAIzC,EAAE4C,IAAF,CAAO,KAAKrC,MAAL,CAAY+B,UAAnB,MAAmC,CAAvC,EAA0C;AACtC,iCAAK/B,MAAL,CAAY+B,UAAZ,GAAyB,IAAzB;AACH;AACD,6BAAKO,UAAL;AACH;;;yDAKqB;AAClBX,gCAAQC,IAAR,CAAa,8BAAb;AACA,4BAAI,CAAC,KAAK/B,KAAL,CAAW0C,oBAAhB,EAAsC;AAClC,iCAAK1C,KAAL,CAAW0C,oBAAX,GAAkC,IAAlC;AACA,iCAAKC,sBAAL;AACA;AACH;;AAED,4BAAI,CAAC,KAAKxC,MAAL,CAAY+B,UAAjB,EAA6B;AACzB,iCAAK/B,MAAL,CAAY+B,UAAZ,GAAyB,EAAzB;AACH;;AAED,6BAAKS,sBAAL;AACA,4BAAI,CAAC,KAAKxC,MAAL,CAAYS,MAAZ,CAAmBsB,UAAxB,EAAoC;AAChC,iCAAK/B,MAAL,CAAY+B,UAAZ,CAAuBU,IAAvB,CAA4B,KAAKzC,MAAL,CAAYgC,mBAAxC;AACA,iCAAKhC,MAAL,CAAYgC,mBAAZ,GAAkC,EAAlC;;AAEA,iCAAKM,UAAL;AACH;;AAED,6BAAKzC,KAAL,CAAW0C,oBAAX,GAAkC,KAAlC;AACH;;;sDAOkBlB,K,EAAOC,Q,EAAU;AAChCK,gCAAQG,GAAR,CAAY,2BAAZ;;AAEA,6BAAKzB,UAAL,CAAgBwB,iBAAhB,GACKL,IADL,CACU,KAAKC,aAAL,CAAmBC,IAAnB,CAAwB,IAAxB,CADV,EAEKF,IAFL,CAEUF,QAFV;AAGH;;;qDAOiBD,K,EAAOC,Q,EAAU;AAC/BK,gCAAQG,GAAR,CAAY,oCAAZ;;AAEA,6BAAKzB,UAAL,CAAgBqC,uBAAhB,CAAwC,KAAK1C,MAAL,CAAYI,MAApD,EAA4D,KAAKJ,MAAL,CAAY2C,aAAxE,EACKnB,IADL,CACU,KAAKC,aAAL,CAAmBC,IAAnB,CAAwB,IAAxB,CADV,EAEKF,IAFL,CAEUF,QAFV;AAGH;;;mDAGe;AACZ,4BAAI,CAAC,KAAKzB,KAAL,CAAW+C,gBAAhB,EAAkC;AAC9B,iCAAK/C,KAAL,CAAW+C,gBAAX,GAA8B,IAA9B;AACA,iCAAKC,iBAAL;AACA;AACH;;AAED,4BAAI,CAAC,KAAK7C,MAAL,CAAY8C,IAAjB,EAAuB;AACnB,iCAAK9C,MAAL,CAAY8C,IAAZ,GAAmB,EAAnB;AACH;;AAED,6BAAKD,iBAAL;AACA,4BAAI,CAAC,KAAK7C,MAAL,CAAYS,MAAZ,CAAmBqC,IAAxB,EAA8B;AAC1B,gCAAI,CAACrD,EAAEsD,GAAF,CAAM,KAAK/C,MAAL,CAAY8C,IAAlB,EAAwB,KAAK9C,MAAL,CAAY2C,aAApC,CAAL,EAAyD;AACrD,qCAAK3C,MAAL,CAAY8C,IAAZ,CAAiB,KAAK9C,MAAL,CAAY2C,aAA7B,IAA8C,EAA9C;AACH;AACD,iCAAK3C,MAAL,CAAY8C,IAAZ,CAAiB,KAAK9C,MAAL,CAAY2C,aAA7B,EAA4CF,IAA5C,CAAiD,KAAKzC,MAAL,CAAYgD,eAA7D;AACA,iCAAKhD,MAAL,CAAY2C,aAAZ,GAA4B,EAA5B;AACA,iCAAK3C,MAAL,CAAYgD,eAAZ,GAA8B,EAA9B;AACA,iCAAKV,UAAL;AACH;;AAED,6BAAKzC,KAAL,CAAW+C,gBAAX,GAA8B,KAA9B;AACH;;;oDAEgBK,G,EAAK;AAClB,+BAAO,KAAKjD,MAAL,CAAY8C,IAAZ,CAAiBG,GAAjB,CAAP;AACA,4BAAIxD,EAAE4C,IAAF,CAAO,KAAKrC,MAAL,CAAY8C,IAAnB,MAA6B,CAAjC,EAAoC;AAChC,iCAAK9C,MAAL,CAAY8C,IAAZ,GAAmB,IAAnB;AACH;AACD,6BAAKR,UAAL;AACH;;;wDAEoB;AACjB,6BAAKtC,MAAL,CAAYS,MAAZ,CAAmBqC,IAAnB,GAA0B,IAA1B;AACA,4BAAI,CAAC,KAAK9C,MAAL,CAAY2C,aAAb,IAA8B,CAAC,KAAK3C,MAAL,CAAYgD,eAA/C,EAAgE;AAC5D,iCAAKhD,MAAL,CAAYS,MAAZ,CAAmBqC,IAAnB,GAA0B,wCAA1B;AACH;AACJ;;;iDAKa;AACV,4BAAI,CAAC,KAAKjD,KAAL,CAAWqD,cAAhB,EAAgC;AAC5B,iCAAKlD,MAAL,CAAYmD,kBAAZ,GAAiC,KAAjC;AACA,iCAAKtD,KAAL,CAAWqD,cAAX,GAA4B,IAA5B;AACA,iCAAKrD,KAAL,CAAWuD,YAAX,GAA0B,IAA1B;AACA,iCAAKC,eAAL;AACA;AACH;AACD,6BAAKA,eAAL;AACA;;AAEA,4BAAI5D,EAAEmB,OAAF,CAAU,KAAKZ,MAAL,CAAYS,MAAZ,CAAmB6C,OAA7B,CAAJ,EAA2C;AACvC,gCAAI,KAAKzD,KAAL,CAAWuD,YAAf,EAA6B;AACzB,oCAAI,CAAC,KAAKpD,MAAL,CAAYuD,WAAjB,EAA8B;AAC1B,yCAAKvD,MAAL,CAAYuD,WAAZ,GAA0B,EAA1B;AACH;AACD,oCAAI,CAAC9D,EAAE+D,QAAF,CAAW,KAAKxD,MAAL,CAAYuD,WAAvB,EAAoC,KAAKvD,MAAL,CAAYsD,OAAZ,CAAoBG,MAAxD,CAAL,EAAsE;AAClE,yCAAKzD,MAAL,CAAYuD,WAAZ,CAAwBd,IAAxB,CAA6B,KAAKzC,MAAL,CAAYsD,OAAZ,CAAoBG,MAAjD;AACA,yCAAKnB,UAAL;AACH;AACD,qCAAKtC,MAAL,CAAYsD,OAAZ,CAAoBG,MAApB,GAA6B,EAA7B;AACH,6BATD,MAUK;AACD,oCAAI,CAAC,KAAKzD,MAAL,CAAY0D,cAAjB,EAAiC;AAC7B,yCAAK1D,MAAL,CAAY0D,cAAZ,GAA6B,EAA7B;AACH;AACD,oCAAIJ,UAAU;AACVK,0CAAM,KAAK3D,MAAL,CAAYmD;AADR,iCAAd;AAGA,oCAAI,KAAKtD,KAAL,CAAW+D,cAAf,EAA+B;AAC3BN,4CAAQO,UAAR,GAAqB,KAAK7D,MAAL,CAAYsD,OAAZ,CAAoBQ,UAAzC;AACH,iCAFD,MAEO,IAAI,KAAKjE,KAAL,CAAWkE,aAAf,EAA8B;AACjCT,4CAAQO,UAAR,GAAqB,KAAK7D,MAAL,CAAYsD,OAAZ,CAAoBU,YAAzC;AACAV,4CAAQW,WAAR,GAAsB,KAAKjE,MAAL,CAAYsD,OAAZ,CAAoBY,UAA1C;AACH;AACD,qCAAKlE,MAAL,CAAY0D,cAAZ,CAA2BjB,IAA3B,CAAgCa,OAAhC;AACH;AACD,iCAAKhB,UAAL;AACH;;AAED,6BAAKzC,KAAL,CAAWuD,YAAX,GAA0B,KAA1B;AACA,6BAAKvD,KAAL,CAAW+D,cAAX,GAA4B,KAA5B;AACA,6BAAK/D,KAAL,CAAWkE,aAAX,GAA2B,KAA3B;AACA,6BAAKlE,KAAL,CAAWqD,cAAX,GAA4B,KAA5B;AACH;;;qDAEiBhB,K,EAAO;AACrB,6BAAKlC,MAAL,CAAYuD,WAAZ,CAAwBnB,MAAxB,CAA+BF,KAA/B,EAAsC,CAAtC;AACA,4BAAIzC,EAAE4C,IAAF,CAAO,KAAKrC,MAAL,CAAYuD,WAAnB,MAAoC,CAAxC,EAA2C;AACvC,iCAAKvD,MAAL,CAAYuD,WAAZ,GAA0B,IAA1B;AACH;AACD,6BAAKjB,UAAL;AACH;;;wDAEoBJ,K,EAAO;AACxB,6BAAKlC,MAAL,CAAY0D,cAAZ,CAA2BtB,MAA3B,CAAkCF,KAAlC,EAAyC,CAAzC;AACA,4BAAIzC,EAAE4C,IAAF,CAAO,KAAKrC,MAAL,CAAY0D,cAAnB,MAAuC,CAA3C,EAA8C;AAC1C,iCAAK1D,MAAL,CAAY0D,cAAZ,GAA6B,IAA7B;AACH;AACD,6BAAKpB,UAAL;AACH;;;yDAEqB;AAClB,6BAAKzC,KAAL,CAAWuD,YAAX,GAA0B,KAAKpD,MAAL,CAAYmD,kBAAZ,KAAmC,KAA7D;AACA,6BAAKtD,KAAL,CAAW+D,cAAX,GAA4B,KAAK5D,MAAL,CAAYmD,kBAAZ,KAAmC,OAA/D;AACA,6BAAKtD,KAAL,CAAWkE,aAAX,GAA2B,KAAK/D,MAAL,CAAYmD,kBAAZ,KAAmC,MAA9D;AACA,6BAAKE,eAAL;AACH;;;uDAEmBC,O,EAAS;AACzB,+BAAO7D,EAAE0E,MAAF,CAASb,OAAT,CAAP;AACH;;;sDAEkB;AACf,+BAAO,KAAKtD,MAAL,CAAYS,MAAZ,CAAmB6C,OAA1B;AACA,4BAAI7C,SAAS,EAAb;AACA,6BAAKZ,KAAL,CAAWuE,cAAX,GAA4B,IAA5B;AACA,4BAAI,KAAKvE,KAAL,CAAWuD,YAAf,EAA6B;AACzB,gCAAI,CAAC,KAAKpD,MAAL,CAAYsD,OAAZ,CAAoBG,MAAzB,EAAiC;AAC7B,qCAAK5D,KAAL,CAAWuE,cAAX,GAA4B,KAA5B;AACA3D,uCAAOgD,MAAP,GAAgB,4BAAhB;AACH;AACJ;;AAED,4BAAI,KAAK5D,KAAL,CAAW+D,cAAf,EAA+B;AAC3B,gCAAI,CAAC,KAAK5D,MAAL,CAAYsD,OAAZ,CAAoBQ,UAArB,IAAmC,CAACzE,MAAM,KAAKW,MAAL,CAAYsD,OAAZ,CAAoBQ,UAA1B,CAAxC,EAA+E;AAC3ErD,uCAAOqD,UAAP,GAAoB,0BAApB;AACA,qCAAKM,cAAL,GAAsB,KAAtB;AACH;AACJ;;AAED,4BAAI,KAAKvE,KAAL,CAAWkE,aAAf,EAA8B;AAC1B,gCAAI;AACA,qCAAK1D,UAAL,CAAgBC,wBAAhB,CAAyC,KAAKN,MAAL,CAAYsD,OAAZ,CAAoBU,YAA7D;AACH,6BAFD,CAEE,OAAOzD,GAAP,EAAY;AACVE,uCAAOuD,YAAP,GAAsBzD,IAAIC,OAA1B;AACA,qCAAK4D,cAAL,GAAsB,KAAtB;AACH;AACD,gCAAI,CAAC,KAAKpE,MAAL,CAAYsD,OAAZ,CAAoBY,UAArB,IAAmC,CAAC7E,MAAM,KAAKW,MAAL,CAAYsD,OAAZ,CAAoBY,UAA1B,CAAxC,EAA+E;AAC3EzD,uCAAOyD,UAAP,GAAoB,gCAApB;AACA,qCAAKE,cAAL,GAAsB,KAAtB;AACH;AACJ;;AAED,4BAAI,CAAC3E,EAAEmB,OAAF,CAAUH,MAAV,CAAL,EAAwB;AACpB,iCAAKT,MAAL,CAAYS,MAAZ,CAAmB6C,OAAnB,GAA6B7C,MAA7B;AACH;AACJ;;;8DAM0B;AACvB,4BAAI,CAAC,KAAKZ,KAAL,CAAWwE,2BAAhB,EAA6C;AACzC,iCAAKxE,KAAL,CAAWwE,2BAAX,GAAyC,IAAzC;AACA,iCAAKrE,MAAL,CAAYsE,+BAAZ,GAA8C,KAA9C;AACA,iCAAKzE,KAAL,CAAW0E,eAAX,GAA6B,IAA7B;AACA,iCAAKC,4BAAL;AACA;AACH;;AAED,6BAAKA,4BAAL;AACA;AACA,4BAAI/E,EAAEmB,OAAF,CAAU,KAAKZ,MAAL,CAAYS,MAAZ,CAAmBgE,aAA7B,CAAJ,EAAiD;AAC7C,gCAAI,CAAC,KAAKzE,MAAL,CAAY0E,qBAAjB,EAAwC;AACpC,qCAAK1E,MAAL,CAAY0E,qBAAZ,GAAoC,EAApC;AACH;AACD,gCAAIC,aAAa;AACbhB,sCAAM,KAAK3D,MAAL,CAAYsE;AADL,6BAAjB;AAGA,gCAAI,KAAKzE,KAAL,CAAW0E,eAAf,EAAgC;AAC5BI,2CAAWC,aAAX,GAA2B,KAAK5E,MAAL,CAAYyE,aAAZ,CAA0BI,YAArD;AACH;AACD,gCAAI,KAAKhF,KAAL,CAAWiF,OAAf,EAAwB;AACpBH,2CAAWI,IAAX,GAAkB,KAAK/E,MAAL,CAAYyE,aAAZ,CAA0BM,IAA5C;AACH;AACD,gCAAI,KAAKlF,KAAL,CAAWmF,SAAf,EAA0B;AACtBL,2CAAWM,MAAX,GAAoB,KAAKjF,MAAL,CAAYyE,aAAZ,CAA0BQ,MAA9C;AACH;AACD,gCAAI,KAAKpF,KAAL,CAAWqF,aAAf,EAA8B;AAC1BP,2CAAWQ,UAAX,GAAwB,KAAKnF,MAAL,CAAYyE,aAAZ,CAA0BU,UAAlD;AACH;AACD,iCAAKnF,MAAL,CAAY0E,qBAAZ,CAAkCjC,IAAlC,CAAuCkC,UAAvC;AACA,iCAAKrC,UAAL;AACH;;AAED,6BAAKzC,KAAL,CAAWwE,2BAAX,GAAyC,KAAzC;AACA,6BAAKxE,KAAL,CAAW0E,eAAX,GAA6B,KAA7B;AACA,6BAAK1E,KAAL,CAAWiF,OAAX,GAAqB,KAArB;AACA,6BAAKjF,KAAL,CAAWmF,SAAX,GAAuB,KAAvB;AACA,6BAAKnF,KAAL,CAAWqF,aAAX,GAA2B,KAA3B;AACH;;;+DAE2BhD,K,EAAO;AAC/B,6BAAKlC,MAAL,CAAY0E,qBAAZ,CAAkCtC,MAAlC,CAAyCF,KAAzC,EAAgD,CAAhD;AACA,4BAAIzC,EAAE4C,IAAF,CAAO,KAAKrC,MAAL,CAAY0E,qBAAnB,MAA8C,CAAlD,EAAqD;AACjD,iCAAK1E,MAAL,CAAY0E,qBAAZ,GAAoC,IAApC;AACH;;AAED,6BAAKpC,UAAL;AACH;;;gEAE4B;AACzB,6BAAKzC,KAAL,CAAW0E,eAAX,GAA6B9E,EAAE+D,QAAF,CAAW,CAAC,KAAD,EAAQ,KAAR,EAAe,KAAf,EAAsB,KAAtB,EAA6B,KAA7B,EAAoC,eAApC,EAAqD,OAArD,EAA8D,YAA9D,CAAX,EACzB,KAAKxD,MAAL,CAAYsE,+BADa,CAA7B;AAEA,6BAAKzE,KAAL,CAAWiF,OAAX,GAAqBrF,EAAE+D,QAAF,CAAW,CAAC,SAAD,EAAY,MAAZ,CAAX,EAAgC,KAAKxD,MAAL,CAAYsE,+BAA5C,CAArB;AACA,6BAAKzE,KAAL,CAAWmF,SAAX,GAAuBvF,EAAE+D,QAAF,CAAW,CAAC,KAAD,EAAQ,OAAR,CAAX,EAA6B,KAAKxD,MAAL,CAAYsE,+BAAzC,CAAvB;AACA,6BAAKzE,KAAL,CAAWqF,aAAX,GAA2B,iBAAiB,KAAKlF,MAAL,CAAYsE,+BAAxD;AACA,6BAAKE,4BAAL;AACH;;;mEAE+B;AAC5B,+BAAO,KAAKxE,MAAL,CAAYS,MAAZ,CAAmBgE,aAA1B;AACA,4BAAIhE,SAAS,EAAb;AACA,6BAAKZ,KAAL,CAAWuF,iBAAX,GAA+B,IAA/B;;AAEA,4BAAI,KAAKvF,KAAL,CAAW0E,eAAf,EAAgC;AAC5B,gCAAI;AACA,qCAAKlE,UAAL,CAAgBC,wBAAhB,CAAyC,KAAKN,MAAL,CAAYyE,aAAZ,CAA0BI,YAAnE;AACH,6BAFD,CAEE,OAAOtE,GAAP,EAAY;AACVE,uCAAOoE,YAAP,GAAsBtE,IAAIC,OAA1B;AACA,qCAAKX,KAAL,CAAWuF,iBAAX,GAA+B,KAA/B;AACH;AACJ;;AAED,4BAAI,KAAKJ,SAAT,EAAoB;AAChB,gCAAI,CAAC,KAAKhF,MAAL,CAAYyE,aAAZ,CAA0BQ,MAA/B,EAAuC;AACnCxE,uCAAOwE,MAAP,GAAgB,qDAAhB;AACA,qCAAKpF,KAAL,CAAWuF,iBAAX,GAA+B,KAA/B;AACH,6BAHD,MAIK,IAAI7F,SAAS,KAAKS,MAAL,CAAYyE,aAAZ,CAA0BQ,MAAnC,MAA+C,CAA/C,IAAoD,KAAKjF,MAAL,CAAYsE,+BAAZ,KAAgD,KAAxG,EAA+G;AAChH7D,uCAAOwE,MAAP,GAAgB,oBAAhB;AACA,qCAAKpF,KAAL,CAAWuF,iBAAX,GAA+B,KAA/B;AACH;AACJ;;AAED,4BAAI,KAAKvF,KAAL,CAAWqF,aAAf,EAA8B;AAC1B,gCAAI,CAAC,KAAKlF,MAAL,CAAYyE,aAAZ,CAA0BU,UAA3B,IACA,KAAKnF,MAAL,CAAYyE,aAAZ,CAA0BU,UAA1B,IAAwC,CADxC,IAEA,KAAKnF,MAAL,CAAYyE,aAAZ,CAA0BU,UAA1B,GAAuC,CAF3C,EAE8C;AAC1C1E,uCAAO0E,UAAP,GAAoB,oCAApB;AACA,qCAAKtF,KAAL,CAAWuF,iBAAX,GAA+B,KAA/B;AACH;AACJ;;AAED,4BAAI,CAAC3F,EAAEmB,OAAF,CAAUH,MAAV,CAAL,EAAwB;AACpB,iCAAKT,MAAL,CAAYS,MAAZ,CAAmBgE,aAAnB,GAAmChE,MAAnC;AACH;AACJ;;;;;;;;;;;;;gCAEMD,O,EAAS;AACZ6E,8BAAM7E,OAAN;AACH,qB;;;;cA1ayChB,S;;;;AA8a9CE,qCAAyB4F,WAAzB,GAAuC,4BAAvC","file":"query-controller.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\r\nimport _ from 'lodash';\r\n\r\nfunction isInt (n) {\r\n    return parseInt(n) % 1 === 0;\r\n}\r\n\r\nexport class ChronixDbQueryController extends QueryCtrl {\r\n\r\n    constructor ($scope, $injector) {\r\n        super($scope, $injector);\r\n\r\n        this.panel.stack = false;\r\n\r\n        if (!this.panel.downsampling) {\r\n            this.panel.downsampling = 'avg';\r\n        }\r\n\r\n        if (!this.target.downsampling) {\r\n            this.target.downsampling = this.panel.downsampling;\r\n            this.target.sampling = this.panel.sampling;\r\n        }\r\n\r\n        this.validateTarget();\r\n    }\r\n\r\n    validateTarget () {\r\n        var errs = {};\r\n\r\n        if (!target.metric) {\r\n            errs.metric = \"You must supply a metric name.\";\r\n        }\r\n\r\n        try {\r\n            if (target.sampling) {\r\n                this.datasource.convertToChronixInterval(target.sampling);\r\n            }\r\n        } catch (err) {\r\n            errs.sampling = err.message;\r\n        }\r\n\r\n        this.target.errors = errs;\r\n    }\r\n\r\n    targetBlur () {\r\n        this.validateTarget();\r\n\r\n        if (!_.isEqual(this.oldTarget, this.target) && _.isEmpty(this.target.errors)) {\r\n            this.oldTarget = angular.copy(this.target);\r\n            this.panelCtrl.refresh();\r\n        }\r\n    };\r\n\r\n    getTextValues (metricFindResult) {\r\n        return _.map(metricFindResult, function (value) {\r\n            return value.text;\r\n        });\r\n    };\r\n\r\n    suggestMetrics (query, callback) {\r\n        this.datasource.metricFindQuery('metrics(' + query + ')')\r\n            .then(this.getTextValues.bind(this))\r\n            .then(callback);\r\n    };\r\n\r\n    /**\r\n     * =========================================================================\r\n     *\r\n     *  Join section\r\n     *\r\n     * =========================================================================\r\n     */\r\n\r\n    /**\r\n     * Is called if someone types something into the join by box\r\n     * @param query\r\n     * @param callback\r\n     */\r\n    addJoinByAttribute (query, callback) {\r\n        console.info(\"add join by attribute is called for \" + query);\r\n\r\n        this.datasource.suggestAttributes(query)\r\n            .then(this.getTextValues.bind(this))\r\n            .then(callback);\r\n    };\r\n\r\n    /**\r\n     * Is called if someone types something into a key field of an attribute\r\n     * @param query\r\n     * @param callback\r\n     */\r\n    suggestTagAttributes (query, callback) {\r\n        console.log(\"suggestTagAttributes is called for \" + query);\r\n\r\n        this.datasource.suggestAttributes(query)\r\n            .then(this.getTextValues.bind(this))\r\n            .then(callback);\r\n    };\r\n\r\n    validateJoinAttributes () {\r\n        console.info(\"validateJoinAttributes is called\");\r\n        this.target.errors.attributes = null;\r\n        if (!this.target.currentAttributeKey) {\r\n            this.target.errors.attributes = \"You must specify a tag name and value.\";\r\n        }\r\n    };\r\n\r\n    /**\r\n     * Is calls if someone removes a group by tag\r\n     * @param attribute\r\n     */\r\n    removeJoinByAttribute (attribute) {\r\n        console.info(\"removeJoinByAttribute is called for \" + attribute);\r\n\r\n        var index = this.target.attributes.indexOf(attribute);\r\n\r\n        this.target.attributes.splice(index, 1);\r\n\r\n        if (_.size(this.target.attributes) === 0) {\r\n            this.target.attributes = null;\r\n        }\r\n        this.targetBlur();\r\n    };\r\n\r\n    /**\r\n     * Add join by attribute\r\n     */\r\n    addJoinByAttribute () {\r\n        console.info(\"addJoinByAttribute is called\");\r\n        if (!this.panel.addJoinAttributeMode) {\r\n            this.panel.addJoinAttributeMode = true;\r\n            this.validateJoinAttributes();\r\n            return;\r\n        }\r\n\r\n        if (!this.target.attributes) {\r\n            this.target.attributes = [];\r\n        }\r\n\r\n        this.validateJoinAttributes();\r\n        if (!this.target.errors.attributes) {\r\n            this.target.attributes.push(this.target.currentAttributeKey);\r\n            this.target.currentAttributeKey = '';\r\n\r\n            this.targetBlur();\r\n        }\r\n\r\n        this.panel.addJoinAttributeMode = false;\r\n    };\r\n\r\n    /**\r\n     * Is called if someone types something into a key field of an attribute\r\n     * @param query\r\n     * @param callback\r\n     */\r\n    suggestAttributes (query, callback) {\r\n        console.log(\"Suggest tag key is called\");\r\n\r\n        this.datasource.suggestAttributes()\r\n            .then(this.getTextValues.bind(this))\r\n            .then(callback);\r\n    };\r\n\r\n    /**\r\n     * Is called if someone types something into a value field of an attribute\r\n     * @param query\r\n     * @param callback\r\n     */\r\n    suggestTagValues (query, callback) {\r\n        console.log(\"Suggest available attribute values\");\r\n\r\n        this.datasource.suggestAttributesValues(this.target.metric, this.target.currentTagKey)\r\n            .then(this.getTextValues.bind(this))\r\n            .then(callback);\r\n    };\r\n\r\n    // Filter metric by tag\r\n    addFilterTag () {\r\n        if (!this.panel.addFilterTagMode) {\r\n            this.panel.addFilterTagMode = true;\r\n            this.validateFilterTag();\r\n            return;\r\n        }\r\n\r\n        if (!this.target.tags) {\r\n            this.target.tags = {};\r\n        }\r\n\r\n        this.validateFilterTag();\r\n        if (!this.target.errors.tags) {\r\n            if (!_.has(this.target.tags, this.target.currentTagKey)) {\r\n                this.target.tags[this.target.currentTagKey] = [];\r\n            }\r\n            this.target.tags[this.target.currentTagKey].push(this.target.currentTagValue);\r\n            this.target.currentTagKey = '';\r\n            this.target.currentTagValue = '';\r\n            this.targetBlur();\r\n        }\r\n\r\n        this.panel.addFilterTagMode = false;\r\n    };\r\n\r\n    removeFilterTag (key) {\r\n        delete this.target.tags[key];\r\n        if (_.size(this.target.tags) === 0) {\r\n            this.target.tags = null;\r\n        }\r\n        this.targetBlur();\r\n    };\r\n\r\n    validateFilterTag () {\r\n        this.target.errors.tags = null;\r\n        if (!this.target.currentTagKey || !this.target.currentTagValue) {\r\n            this.target.errors.tags = \"You must specify a tag name and value.\";\r\n        }\r\n    };\r\n\r\n    //////////////////////////////\r\n    // GROUP BY\r\n    //////////////////////////////\r\n    addGroupBy () {\r\n        if (!this.panel.addGroupByMode) {\r\n            this.target.currentGroupByType = 'tag';\r\n            this.panel.addGroupByMode = true;\r\n            this.panel.isTagGroupBy = true;\r\n            this.validateGroupBy();\r\n            return;\r\n        }\r\n        this.validateGroupBy();\r\n        // nb: if error is found, means that user clicked on cross : cancels input\r\n\r\n        if (_.isEmpty(this.target.errors.groupBy)) {\r\n            if (this.panel.isTagGroupBy) {\r\n                if (!this.target.groupByTags) {\r\n                    this.target.groupByTags = [];\r\n                }\r\n                if (!_.contains(this.target.groupByTags, this.target.groupBy.tagKey)) {\r\n                    this.target.groupByTags.push(this.target.groupBy.tagKey);\r\n                    this.targetBlur();\r\n                }\r\n                this.target.groupBy.tagKey = '';\r\n            }\r\n            else {\r\n                if (!this.target.nonTagGroupBys) {\r\n                    this.target.nonTagGroupBys = [];\r\n                }\r\n                var groupBy = {\r\n                    name: this.target.currentGroupByType\r\n                };\r\n                if (this.panel.isValueGroupBy) {\r\n                    groupBy.range_size = this.target.groupBy.valueRange;\r\n                } else if (this.panel.isTimeGroupBy) {\r\n                    groupBy.range_size = this.target.groupBy.timeInterval;\r\n                    groupBy.group_count = this.target.groupBy.groupCount;\r\n                }\r\n                this.target.nonTagGroupBys.push(groupBy);\r\n            }\r\n            this.targetBlur();\r\n        }\r\n\r\n        this.panel.isTagGroupBy = false;\r\n        this.panel.isValueGroupBy = false;\r\n        this.panel.isTimeGroupBy = false;\r\n        this.panel.addGroupByMode = false;\r\n    };\r\n\r\n    removeGroupByTag (index) {\r\n        this.target.groupByTags.splice(index, 1);\r\n        if (_.size(this.target.groupByTags) === 0) {\r\n            this.target.groupByTags = null;\r\n        }\r\n        this.targetBlur();\r\n    };\r\n\r\n    removeNonTagGroupBy (index) {\r\n        this.target.nonTagGroupBys.splice(index, 1);\r\n        if (_.size(this.target.nonTagGroupBys) === 0) {\r\n            this.target.nonTagGroupBys = null;\r\n        }\r\n        this.targetBlur();\r\n    };\r\n\r\n    changeGroupByInput () {\r\n        this.panel.isTagGroupBy = this.target.currentGroupByType === 'tag';\r\n        this.panel.isValueGroupBy = this.target.currentGroupByType === 'value';\r\n        this.panel.isTimeGroupBy = this.target.currentGroupByType === 'time';\r\n        this.validateGroupBy();\r\n    };\r\n\r\n    getValuesOfGroupBy (groupBy) {\r\n        return _.values(groupBy);\r\n    };\r\n\r\n    validateGroupBy () {\r\n        delete this.target.errors.groupBy;\r\n        var errors = {};\r\n        this.panel.isGroupByValid = true;\r\n        if (this.panel.isTagGroupBy) {\r\n            if (!this.target.groupBy.tagKey) {\r\n                this.panel.isGroupByValid = false;\r\n                errors.tagKey = 'You must supply a tag name';\r\n            }\r\n        }\r\n\r\n        if (this.panel.isValueGroupBy) {\r\n            if (!this.target.groupBy.valueRange || !isInt(this.target.groupBy.valueRange)) {\r\n                errors.valueRange = \"Range must be an integer\";\r\n                this.isGroupByValid = false;\r\n            }\r\n        }\r\n\r\n        if (this.panel.isTimeGroupBy) {\r\n            try {\r\n                this.datasource.convertToChronixInterval(this.target.groupBy.timeInterval);\r\n            } catch (err) {\r\n                errors.timeInterval = err.message;\r\n                this.isGroupByValid = false;\r\n            }\r\n            if (!this.target.groupBy.groupCount || !isInt(this.target.groupBy.groupCount)) {\r\n                errors.groupCount = \"Group count must be an integer\";\r\n                this.isGroupByValid = false;\r\n            }\r\n        }\r\n\r\n        if (!_.isEmpty(errors)) {\r\n            this.target.errors.groupBy = errors;\r\n        }\r\n    };\r\n\r\n    //////////////////////////////\r\n    // HORIZONTAL AGGREGATION\r\n    //////////////////////////////\r\n\r\n    addHorizontalAggregator () {\r\n        if (!this.panel.addHorizontalAggregatorMode) {\r\n            this.panel.addHorizontalAggregatorMode = true;\r\n            this.target.currentHorizontalAggregatorName = 'avg';\r\n            this.panel.hasSamplingRate = true;\r\n            this.validateHorizontalAggregator();\r\n            return;\r\n        }\r\n\r\n        this.validateHorizontalAggregator();\r\n        // nb: if error is found, means that user clicked on cross : cancels input\r\n        if (_.isEmpty(this.target.errors.horAggregator)) {\r\n            if (!this.target.horizontalAggregators) {\r\n                this.target.horizontalAggregators = [];\r\n            }\r\n            var aggregator = {\r\n                name: this.target.currentHorizontalAggregatorName\r\n            };\r\n            if (this.panel.hasSamplingRate) {\r\n                aggregator.sampling_rate = this.target.horAggregator.samplingRate;\r\n            }\r\n            if (this.panel.hasUnit) {\r\n                aggregator.unit = this.target.horAggregator.unit;\r\n            }\r\n            if (this.panel.hasFactor) {\r\n                aggregator.factor = this.target.horAggregator.factor;\r\n            }\r\n            if (this.panel.hasPercentile) {\r\n                aggregator.percentile = this.target.horAggregator.percentile;\r\n            }\r\n            this.target.horizontalAggregators.push(aggregator);\r\n            this.targetBlur();\r\n        }\r\n\r\n        this.panel.addHorizontalAggregatorMode = false;\r\n        this.panel.hasSamplingRate = false;\r\n        this.panel.hasUnit = false;\r\n        this.panel.hasFactor = false;\r\n        this.panel.hasPercentile = false;\r\n    };\r\n\r\n    removeHorizontalAggregator (index) {\r\n        this.target.horizontalAggregators.splice(index, 1);\r\n        if (_.size(this.target.horizontalAggregators) === 0) {\r\n            this.target.horizontalAggregators = null;\r\n        }\r\n\r\n        this.targetBlur();\r\n    };\r\n\r\n    changeHorAggregationInput () {\r\n        this.panel.hasSamplingRate = _.contains(['avg', 'dev', 'max', 'min', 'sum', 'least_squares', 'count', 'percentile'],\r\n            this.target.currentHorizontalAggregatorName);\r\n        this.panel.hasUnit = _.contains(['sampler', 'rate'], this.target.currentHorizontalAggregatorName);\r\n        this.panel.hasFactor = _.contains(['div', 'scale'], this.target.currentHorizontalAggregatorName);\r\n        this.panel.hasPercentile = 'percentile' === this.target.currentHorizontalAggregatorName;\r\n        this.validateHorizontalAggregator();\r\n    };\r\n\r\n    validateHorizontalAggregator () {\r\n        delete this.target.errors.horAggregator;\r\n        var errors = {};\r\n        this.panel.isAggregatorValid = true;\r\n\r\n        if (this.panel.hasSamplingRate) {\r\n            try {\r\n                this.datasource.convertToChronixInterval(this.target.horAggregator.samplingRate);\r\n            } catch (err) {\r\n                errors.samplingRate = err.message;\r\n                this.panel.isAggregatorValid = false;\r\n            }\r\n        }\r\n\r\n        if (this.hasFactor) {\r\n            if (!this.target.horAggregator.factor) {\r\n                errors.factor = 'You must supply a numeric value for this aggregator';\r\n                this.panel.isAggregatorValid = false;\r\n            }\r\n            else if (parseInt(this.target.horAggregator.factor) === 0 && this.target.currentHorizontalAggregatorName === 'div') {\r\n                errors.factor = 'Cannot divide by 0';\r\n                this.panel.isAggregatorValid = false;\r\n            }\r\n        }\r\n\r\n        if (this.panel.hasPercentile) {\r\n            if (!this.target.horAggregator.percentile ||\r\n                this.target.horAggregator.percentile <= 0 ||\r\n                this.target.horAggregator.percentile > 1) {\r\n                errors.percentile = 'Percentile must be between 0 and 1';\r\n                this.panel.isAggregatorValid = false;\r\n            }\r\n        }\r\n\r\n        if (!_.isEmpty(errors)) {\r\n            this.target.errors.horAggregator = errors;\r\n        }\r\n    };\r\n\r\n    alert (message) {\r\n        alert(message);\r\n    };\r\n\r\n}\r\n\r\nChronixDbQueryController.templateUrl = 'partials/query.editor.html';\r\n"]}